---
title: HTTPS的数字证书验证原理
date: 2019-04-24 19:11:15
tags:
---

通常网络请求我们分为两种，分别是 HTTP 请求和 HTTPS 请求，而 HTTPS 是一种在 HTTP 的基础上加了 SSL/TLS 层（安全套接层）的安全的超文本传输协议。HTTP 的传输属于明文传输，所以说是不安全的，在传输的过程中容易被人截取并且偷窥其中的内容，而 HTTPS 传输的信息是通过加密的，也是一种安全的传输。

<!--more-->

转载自 [CSND 十月](https://me.csdn.net/liuxingrong666)
原文连接 https://blog.csdn.net/liuxingrong666/article/details/83869161

## 两类加密算法

说到加密算法，先来了解一下两类常用的加密方式，分别是对称加密和非对称加密：

1. 对称加密：加密使用的秘钥和解密使用的秘钥是相同的，也就是说加密和解密都使用同一个秘钥，加密算法是公开的，秘钥是加密者和解密者绝对保密的。

2. 非对称加密：加密使用的秘钥和解密使用的秘钥是不相同的，HTTPS 在数字证书验证的时候，采用的 RSA 密码体制就是一种非对称加密。

RSA 是一种公钥秘钥密码体制，现在使用非常广泛，这个密码体制分为三部分，公钥、私钥、加密算法，其中公钥和加密算法是公布的，私钥是自己保密的。这种机制最大的特点是，通过公钥加密的密文只有对应的私钥才能解密，同样通过私钥加密的密文也是只有对应的公钥才能解密。下面我们将会讲到 HTTPS 是如何通过 RSA 这种密码体制去验证身份的。

## 数字证书

先了解一下数字证书，它有点像身份证，是由权威的 CA 机构颁发的，证书的主要内容有：公钥（Public Key）、ISSUER（证书的发布机构）、Subject（证书持有者）、证书有效期、签名算法、指纹及指纹算法。

下面 csdn 博客的 CA 证书内容：

![CSDN博客CA证书](https://github.com/MeetzhDing/Meetzhding.github.io/blob/Blog/picture/CSDN博客CA证书.png?raw=true)

可以看到公钥是一串很长的 2048 Bits 的字符串，同时也可以看到使用者内容包含了 csdn.net 网址，这个网址是 CSDN 唯一拥有的，还有颁发者、有效期、签名哈希算法等等。当然还有指纹及指纹算法等其他内容，我们滚动到下面看看另外一个截图

![CSDN博客CA证书](https://github.com/MeetzhDing/Meetzhding.github.io/blob/Blog/picture/CSDN博客CA证书指纹.png?raw=true)

这里特别说明一下，CA 机构也有自己的证书，我们姑且称之为根证书，它也有自己的公钥和私钥，我称之为根公钥和根私钥吧。当然根公钥和加密算法是向外公布的，而根私钥是机构自己绝对保密的。

指纹是一个证书的签名，是通过指纹算法 sha1 计算出来的一个 hash 值，这个很重要，是用来验证证书内容有没有被篡改的。证书在发布之前，CA 机构会把所颁发证书的内容用根私钥通过指纹算法计算出一个 hash 值，这个 hash 值只能通过对应机构的根公钥才能解密，所以在验证证书的时候，我们通过同样的指纹算法把证书内容进行 hash 计算得到另一个 hash 值，如果这个 hash 值跟证书上自带的 hash 值相同，就代表证书没有被修改过。

## 实例分析

下面我们将基于一个简单的图例，去分析整个 HTTPS 的数字证书验证是怎么样的一个过程

图示如下：

![Https加密过程](https://github.com/MeetzhDing/Meetzhding.github.io/blob/Blog/picture/Https加密过程.gif?raw=true)

假设这是一个浏览器的 HTTPS 请求。

### 浏览器发出请求

首先浏览器通过 URL 网址去请求某个后台服务器，服务器接收到请求后，就会给浏览器发送一个自己的 CA 数字证书。

### 浏览器进行证书校验工作

浏览器接收到数字证书以后，就要进行验证工作了。首先从证书的内容中获取证书的颁发机构，然后从浏览器系统中去寻找此颁发机构是否为浏览器的信任机构。这里解析一下，世界上就几个权威的 CA 机构，这几个机构都是预先嵌入到我们的浏览器系统中的。如果接收到一个数字证书但其颁发机构没有在我们浏览器系统中的，那么就会有警告提示，无法确认证书的真假。如果是受信任的机构，那么就到下一步。

此时我们就可以从浏览器中找到对应的机构的根公钥，用这个公钥去解析证书的签名得到一个 hash 值 H1，上面提到过，这个签名是证书发布之前 CA 机构用自己的私钥加密而成的，所以这里只能由根证书的根公钥去解密。然后用证书的指纹算法对证书的内容再进行 hash 计算得到另一个 hash 值 H2，通过 H1 和 H2 的比对，如果相等，就代表证书没有被修改过，可以信任。此时再检查证书的持有者对应的 URL（比如 csdn.net）是否为我们请求的 URL，如果是，那么就可以证明浏览器当前连接的是正确的网址，而不是一些钓鱼网之类的。

这里我们假设，如果浏览器的连接被某个钓鱼网截取了，钓鱼网也可以发一个自己的证书给浏览器，然后通过了证书没有被篡改的验证，但是在证书没有被篡改的情况下，通过对比证书上的 URL 和我们请求的 URL，就可以知道这个证书的 URL 不是我们所要连接的网址，所以说钓鱼网页骗不了我们。

看到这里不是很明白这个证书验证的话，我特别解析一下，我们知道 CA 机构有自己的根公钥和根私钥。在证书颁发之前，机构会用根私钥将这个证书内容加密得到一个签名，这个签名只能用对应的根公钥去解密。在客户端（浏览器）收到服务器发过来的证书以后，我们首先从浏览器中拿到机构的根公钥，用这个根公钥去解析证书的签名得到一个哈希值 H1，这个 H1 代表证书的原始内容，即便你自己去生成了一个证书的签名，但是你这个签名不可能是用根私钥去加密生成的（因为根私钥是 CA 机构私有），所以根公钥也不可能去解密任何第三方生成的签名（加密内容只能由对应的公钥私钥解析）。然后下一步我们再用同样的哈希算法对收证书内容进行计算得到哈希值 H2，通过对比 H1 和 H2 是否相等就知道证书有没有被褚篡改过了。讲到这里，我们应该明白证书是否被篡改的验证机制了吧。

### 将对称秘钥安全传输到服务器
此时第二步完成了，可以确认是浏览器的连接网址是正确的，是我们想要连接的那个服务器，而此时也拿到了证书上的公钥。下一步有一个很重要的任务就是，如何将一个对称加密算法的秘钥安全地发给服务器，首先随机生成一个字符串 R 作为我们的秘钥，然后通过证书公钥加密成密文，将密文发送给服务器。因为此密文是用公钥加密的，这是一个非对称加密，我们知道，这个密文只有私钥的持有者才能进行解密，所以说任何第三方截取到密文也是没用的，因为没有对应的私钥所以解析不出来。

这里还有一个很重要的步骤是，发送密文的时候，会对消息内容进行签名操作。签名上面讲解过，就是对密文内容进行 hash 计算得到的一个 hash 值，同时将这个 hash 值进行加密和消息内容一起发送出去。接收方收到消息以后，通过私钥解析密文，同时也会对消息内容进行同样的 hash 计算得到 hash 值，通过比对两个 hash 值是否相同来判断密文是否有修改过。

### 双方获取到对称加密秘钥
通过第三步的操作，此时客户端和服务器都拥有了对称加密算法的秘钥，因为只有它们两者知道，所以此时兄弟两就可以愉快地安全通信了。

<br>
## 总结
通过上面我们可以看到，有两个非常重要的步骤，第一是验证数字证书的正确性还有连接网址是否正确，第二是通过 RSA 机制的原理安全地进行了对称加密算法秘钥的输送。这两步都完成以后，整个 HTTPS 的数字证书的验证就算是成功了。

好了，通过上面 的讲解，相信我们已经掌握了 https 的数字证书验证原理了。